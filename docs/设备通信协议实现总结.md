# 设备通信协议实现总结

## ✅ 已完成的工作

根据《旧物回收通信协议.docx》文档要求，已完成 4G 硬件设备与后台服务的完整通信协议实现。

## 📁 新增/修改的文件

### 1. 设计文档
- ✅ `docs/设备通信协议设计文档.md` - 完整的协议设计文档
- ✅ `docs/设备通信协议实现说明.md` - 实现说明和使用指南（v3.0）
- ✅ `docs/设备通信协议实现总结.md` - 本文档
- ✅ `docs/设备通信协议测试文档.md` - 完整测试文档

### 2. 后端代码

#### Schema定义
- ✅ `backend/app/schemas/device.py` - 按协议重新定义
  - `DeviceStatusReportRequest` - 设备常规状态上报
  - `HeartbeatReportRequest` - 设备心跳上报
  - `ServerAckResponse` - 后台应答报文
  - `TimeSyncResponse` - 时间同步报文
  - `QueryDeviceStatusRequest` - 主动查询设备状态

#### 服务层
- ✅ `backend/app/services/device_service.py` - 设备服务层
  - **`DeviceConnectionManager` - 统一设备连接管理器** ⭐
    - 管理 WebSocket 长连接和 HTTP 长轮询两种通道
    - `ws_connect()` / `ws_disconnect()` - WebSocket 连接管理
    - `ws_send()` - 通过 WebSocket 发送消息
    - `get_lp_channel()` / `is_lp_listening()` - 长轮询管理
    - `send_to_device()` - 统一命令发送（WebSocket > 长轮询）
    - `get_connection_type()` - 获取设备连接类型
    - `get_online_summary()` - 在线设备统计
  - `DeviceService` - 设备服务类
    - `verify_check_code()` - MD5校验码验证
    - `process_device_status_report()` - 处理常规状态上报
    - `process_heartbeat_report()` - 处理心跳上报
    - `send_command()` - 发送命令（WebSocket > 长轮询 > 数据库排队）
    - `build_server_ack()` - 创建后台应答报文
    - `build_time_sync()` - 创建时间同步报文

#### API接口
- ✅ `backend/app/api/v1/device_communication.py` - 设备通信API
  - **`WebSocket /api/v1/device/ws/{device_id}` - 设备双向长连接端点** ⭐
  - `POST /api/v1/device/report` - 设备状态上报接口
  - `POST /api/v1/device/heartbeat` - 设备心跳上报接口
  - `GET /api/v1/device/listen/{device_id}` - 长轮询监听（向下兼容）
  - `POST /api/v1/device/query-status` - 后台查询设备状态
  - `GET /api/v1/device/pending-commands/{device_id}` - 设备轮询命令（向下兼容）
  - `POST /api/v1/device/time-sync` - 时间同步指令

#### 数据模型
- ✅ `backend/app/models/device.py` - 设备模型（新增协议字段）
  - `battery_level` - 电池电量
  - `smoke_sensor_status` - 烟感状态
  - `recycle_bin_full` - 仓体满载
  - `delivery_window_open` - 投放窗口
  - `is_using` - 使用状态（仅表示当前是否有人使用）
  - `firmware_version` - 固件版本
  - `first_report_at` - 首次上报时间（NULL=从未上报，用于判断 time_sync）
  - `pending_command` - 待执行命令（设备离线时排队使用）
  - `pending_command_at` - 命令排队时间

#### 路由注册
- ✅ `backend/app/api/v1/__init__.py` - 已注册设备通信路由

#### 依赖
- ✅ `backend/requirements.txt` - 添加 `websockets>=12.0`

### 3. 管理后台
- ✅ `admin/src/api/admin.js` - API 接口函数
- ✅ `admin/src/views/device/index.vue` - 设备列表
  - 新增「连接」列显示 WS / LP / 离线
  - 命令下发显示具体连接类型
- ✅ `admin/src/views/device/detail.vue` - 设备详情
  - 显示设备连接类型标签
  - 命令下发显示具体连接类型

### 4. 测试脚本
- ✅ `backend/scripts/test_heartbeat.py` - 协议测试脚本
  - P1~P2: 离线测试
  - T1~T11: HTTP 在线测试
  - **T12: WebSocket 连接 + 心跳** ⭐
  - **T13: WebSocket 命令实时推送** ⭐

## 🔧 核心功能

### 功能1: WebSocket 长连接通信 ⭐ (v3.0 新增)

**设备端只需建立一条 WebSocket 连接，即可完成所有通信：**

| 方向 | 消息类型 | 说明 |
|------|----------|------|
| 上行 | heartbeat_report | 心跳包（建议每8小时，保活可更频繁） |
| 上行 | device_status_report | 状态上报（含传感器+摄像头数据） |
| 下行 | server_ack | 服务器应答 |
| 下行 | time_sync | 时间同步 |
| 下行 | query_device_status | 后台主动查询（实时推送） |

**连接管理：**
- 设备连接时自动标记为在线
- 设备断开时自动标记为离线
- 支持旧连接自动替换（同一设备ID新连接替换旧连接）

**端点**：`ws://server/api/v1/device/ws/{device_id}`

### 功能2: 设备常规状态上报

**流程**：
1. 设备检测到状态变化
2. 构建 `device_status_report` 报文
3. 通过 WebSocket 发送（或 HTTP POST）
4. 后台验证MD5 → 更新设备状态
5. 返回 `server_ack` 应答
6. **首次上报**：额外返回 `time_sync`

### 功能3: 设备心跳上报

**流程**：
1. 设备每8小时发送心跳
2. 通过 WebSocket 发送（或 HTTP POST）
3. 后台验证 → 更新在线状态
4. 返回 `server_ack` + `time_sync`
5. 如有待执行命令（pending_command），一并下发

### 功能4: 后台主动下发指令

**命令下发优先级**：
1. **WebSocket** → 直接推送，设备立即收到（`delivery_method=websocket`）
2. **长轮询** → 推入 asyncio.Queue（`delivery_method=long_polling`）
3. **数据库排队** → 写入 pending_command（`delivery_method=queued`）

### 功能5: 小程序扫码上报

**接口**：`POST /api/v1/order/scan`（已有功能）

## 🔐 安全机制

### 1. 报文完整性校验
- 包头(0x6868)/包尾(0x1616)验证
- MD5校验码验证
- 校验失败直接丢弃报文

### 2. 时间戳验证
- 设备时间戳必须在服务器时间 ±5分钟 内
- 通过时间同步指令校正设备时钟

### 3. 设备注册验证
- 设备ID必须在数据库中已注册
- 未注册设备的报文直接丢弃

## 🧪 测试方法

### 1. 使用测试脚本

```bash
cd backend
python scripts/test_heartbeat.py                    # 全部测试
python scripts/test_heartbeat.py --offline-only     # 仅离线测试
python scripts/test_heartbeat.py --api http://localhost:8000/api/v1
```

### 2. WebSocket 测试（需安装 websockets 库）

测试脚本中 T12 和 T13 自动测试 WebSocket 功能。如未安装 `websockets`：

```bash
pip install websockets
```

### 3. 使用curl测试

```bash
curl -X POST http://localhost:8000/api/v1/device/heartbeat \
  -H "Content-Type: application/json" \
  -d '{
    "msg_type": "heartbeat_report",
    "device_id": "DEV001",
    "timestamp": "2026-01-30 10:00:00",
    "check_code": "对应的MD5值"
  }'
```

## 📋 硬件端实现检查清单

- [ ] 设备ID格式：`DEV_YYYYMMDDXXXX`
- [ ] MD5校验码计算
- [ ] **⭐ WebSocket 客户端实现**：连接 `ws://server/api/v1/device/ws/{device_id}`
- [ ] **⭐ WebSocket 自动重连**：断线后自动重新连接
- [ ] **⭐ 通过 WebSocket 发送心跳**：定期发送 heartbeat_report 保活
- [ ] **⭐ 通过 WebSocket 发送状态上报**：状态变化时上报
- [ ] **⭐ 监听 WebSocket 下行消息**：处理 server_ack / time_sync / query_device_status
- [ ] 收到 query_device_status 后立即采集并上报全量状态
- [ ] 摄像头数据Base64编码
- [ ] 时间同步指令处理
- [ ] （可选）HTTP 心跳上报（作为 WebSocket 不可用时的备选方案）
- [ ] （可选）HTTP 长轮询监听（作为 WebSocket 不可用时的备选方案）

## 🎯 下一步

1. **硬件端开发**：实现 WebSocket 客户端，优先使用长连接通信
2. **联调测试**：使用测试脚本进行端到端验证
3. **小程序适配**：确保小程序扫码上报流程正确
4. **部署上线**：将更新部署到生产服务器

## 📚 相关文档

- [设备通信协议设计文档](./设备通信协议设计文档.md) - 完整的协议规范
- [设备通信协议实现说明](./设备通信协议实现说明.md) - 实现细节和使用指南
- [设备通信协议测试文档](./设备通信协议测试文档.md) - 完整测试文档
- [数据库表结构说明](./数据库表结构说明.md) - 数据库设计

---

**实现完成时间**：2026-02-08  
**版本**：v3.0 (WebSocket 长连接支持)  
**状态**：✅ 已完成
