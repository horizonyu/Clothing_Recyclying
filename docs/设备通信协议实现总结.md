# 设备通信协议实现总结

## ✅ 已完成的工作

根据《旧物回收通信协议.docx》文档要求，已完成 4G 硬件设备与后台服务的完整通信协议实现。

## 📁 新增/修改的文件

### 1. 设计文档
- ✅ `docs/设备通信协议设计文档.md` - 完整的协议设计文档（v2.0）
- ✅ `docs/设备通信协议实现说明.md` - 实现说明和使用指南（v2.0）
- ✅ `docs/设备通信协议实现总结.md` - 本文档

### 2. 后端代码

#### Schema定义
- ✅ `backend/app/schemas/device.py` - 按协议重新定义
  - `DeviceStatusReportRequest` - 设备常规状态上报
  - `HeartbeatReportRequest` - 设备心跳上报
  - `ServerAckResponse` - 后台应答报文
  - `TimeSyncResponse` - 时间同步报文
  - `QueryDeviceStatusRequest` - 主动查询设备状态

#### 服务层
- ✅ `backend/app/services/device_service.py` - 设备服务层（按协议重写）
  - `DeviceService` - 设备服务类
  - `verify_check_code()` - MD5校验码验证
  - `verify_timestamp()` - 时间戳验证（±5分钟容差）
  - `handle_device_status_report()` - 处理常规状态上报
  - `handle_heartbeat_report()` - 处理心跳上报
  - `create_server_ack()` - 创建后台应答报文
  - `create_time_sync()` - 创建时间同步报文

#### API接口
- ✅ `backend/app/api/v1/device_communication.py` - 设备通信API（按协议重写）
  - `POST /api/v1/device/report` - 设备状态上报接口
  - `POST /api/v1/device/heartbeat` - 设备心跳上报接口
  - `POST /api/v1/device/command/time_sync` - 时间同步指令
  - `POST /api/v1/device/command/query_status` - 查询设备状态指令

#### 数据模型
- ✅ `backend/app/models/device.py` - 设备模型（新增协议字段）
  - `battery_level` - 电池电量
  - `smoke_sensor_status` - 烟感状态
  - `recycle_bin_full` - 仓体满载
  - `delivery_window_open` - 投放窗口
  - `is_using` - 使用状态（仅表示当前是否有人使用，不参与首次上报判断）
  - `firmware_version` - 固件版本
  - `first_report_at` - 首次上报时间（NULL=从未上报，用于判断是否触发 time_sync）
  - `pending_command` - 待执行命令(JSON)
  - `pending_command_at` - 命令排队时间

#### 路由注册
- ✅ `backend/app/api/v1/__init__.py` - 已注册设备通信路由

### 3. 测试脚本
- ✅ `backend/scripts/test_heartbeat.py` - 协议测试脚本（按协议重写）

## 🔧 核心功能

### 功能1：设备常规状态上报

**流程**：
1. 设备检测到状态变化
2. 构建 `device_status_report` 报文
3. 计算MD5校验码
4. 通过HTTP POST上报到后台
5. 后台验证MD5 → 验证时间戳 → 更新设备状态
6. 返回 `server_ack` 应答
7. **首次上报**：如果 `first_report_at` 为 NULL，额外返回 `time_sync` 时间同步消息

**接口**：`POST /api/v1/device/report`

### 功能2：设备心跳上报

**流程**：
1. 设备每8小时发送心跳
2. 构建 `heartbeat_report` 报文（无data字段）
3. 计算MD5校验码
4. 通过HTTP POST上报到后台
5. 后台验证 → 更新在线状态
6. 返回 time_sync 时间同步指令 + server_ack 应答
7. 如有待执行命令(pending_command)，一并下发

**接口**：`POST /api/v1/device/heartbeat`

### 功能3：小程序扫码上报

**流程**：
1. 用户投递完成后，硬件生成二维码
2. 二维码内容为完整的设备状态上报报文
3. 用户微信扫码，小程序解析二维码数据
4. 小程序将数据提交到 `POST /api/v1/order/scan`
5. 后台验证MD5校验码，创建订单
6. 用户确认领取

**接口**：`POST /api/v1/order/scan`

### 功能4：后台主动下发指令

**支持的指令**：
- `time_sync` - 时间同步
- `query_device_status` - 查询设备状态

**接口**：
- `POST /api/v1/device/command/time_sync`
- `POST /api/v1/device/command/query_status`

## 🔐 安全机制

### 1. 报文完整性校验
- 包头(0x6868)/包尾(0x1616)验证
- MD5校验码验证
- 校验失败直接丢弃报文

### 2. 时间戳验证
- 设备时间戳必须在服务器时间 ±5分钟 内
- 防止重放攻击
- 通过时间同步指令校正设备时钟

### 3. 设备注册验证
- 设备ID必须在数据库中已注册
- 未注册设备的报文直接丢弃

## 🧪 测试方法

### 1. 使用测试脚本

```bash
cd backend
python scripts/test_heartbeat.py
```

测试内容：
- MD5校验码计算验证
- 设备状态上报（正常/使用中）
- 心跳包上报
- 小程序扫码上报（模拟）

### 2. 使用curl测试

```bash
# 测试心跳接口
curl -X POST http://localhost:8000/api/v1/device/heartbeat \
  -H "Content-Type: application/json" \
  -d '{
    "msg_type": "heartbeat_report",
    "device_id": "DEV001",
    "timestamp": "2026-01-30 10:00:00",
    "check_code": "对应的MD5值"
  }'
```

### 3. 查看API文档

启动服务后访问：`http://localhost:8000/docs`（需 DEBUG=true）

## 📋 与旧版协议的主要变更

| 项目 | 旧版（v1.0） | 新版（v2.0） |
|------|-------------|-------------|
| 心跳频率 | 30秒/次 | 8小时/次 |
| 签名算法 | HMAC-SHA256 | MD5校验码 |
| 报文格式 | 纯JSON | 包头+JSON+包尾 |
| 认证方式 | Header密钥认证 | MD5校验码 |
| 时间戳格式 | Unix时间戳(int) | 字符串 yyyy-MM-dd HH:mm:ss |
| 状态上报 | 通过心跳携带 | 独立的状态上报报文 |
| 投递记录 | 通过心跳携带 | 小程序扫码上报 |
| 时间同步 | 响应中server_time字段 | 独立的time_sync指令 |
| 状态字段 | door_status/capacity_percent | smoke_sensor/recycle_bin_full/delivery_window |

## 📋 硬件端实现检查清单

- [ ] 设备ID格式：`DEV_YYYYMMDDXXXX`
- [ ] MD5校验码计算
- [ ] 常规状态上报报文构建
- [ ] 心跳包上报（8小时间隔）
- [ ] 二维码生成（含完整报文）
- [ ] 时间同步指令处理
- [ ] 摄像头数据Base64编码

## 🎯 下一步

1. **硬件端开发**：根据协议文档实现硬件端代码
2. **联调测试**：使用测试脚本进行端到端验证
3. **小程序适配**：确保小程序扫码上报流程正确
4. **部署上线**：将更新部署到生产服务器

## 📚 相关文档

- [设备通信协议设计文档](./设备通信协议设计文档.md) - 完整的协议规范
- [设备通信协议实现说明](./设备通信协议实现说明.md) - 实现细节和使用指南
- [数据库表结构说明](./数据库表结构说明.md) - 数据库设计

---

**实现完成时间**：2026-02-08  
**版本**：v2.0  
**状态**：✅ 已完成
