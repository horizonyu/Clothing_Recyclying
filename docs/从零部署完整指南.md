# 从零部署完整指南

本指南将带您从申请云服务器开始，一步步完成后端部署，直到小程序可以正常交互。

---

## 📋 准备工作清单

在开始之前，请确认您已准备：

- [ ] 身份证（实名认证用）
- [ ] 手机号（接收验证码）
- [ ] 支付方式（支付宝/微信/银行卡）
- [ ] 一个域名（可选，但推荐）
- [ ] 微信小程序的 AppID 和 AppSecret

---

## 第一步：申请云服务器

### 1.1 选择云服务商

| 服务商 | 优点 | 新用户优惠 | 推荐指数 |
|-------|------|-----------|---------|
| **阿里云** | 稳定、文档全 | 首购1年99元起 | ⭐⭐⭐⭐⭐ |
| **腾讯云** | 小程序生态好 | 首购1年99元起 | ⭐⭐⭐⭐⭐ |
| **华为云** | 企业级 | 首购有优惠 | ⭐⭐⭐⭐ |

**推荐配置**（够用即可）：

| 配置项 | 最低配置 | 推荐配置 |
|-------|---------|---------|
| CPU | 1核 | 2核 |
| 内存 | 2GB | 4GB |
| 硬盘 | 40GB | 50GB |
| 带宽 | 1Mbps | 3Mbps |
| 系统 | Ubuntu 22.04 | Ubuntu 22.04 |

### 1.2 阿里云购买流程

1. **访问阿里云官网**
   - 打开 https://www.aliyun.com/
   - 点击右上角「登录」或「免费注册」

2. **实名认证**
   - 登录后点击右上角头像 → 「实名认证」
   - 选择「个人认证」或「企业认证」
   - 按提示上传身份证完成认证

3. **购买服务器**
   - 进入「产品」→「云服务器 ECS」
   - 或直接访问新用户优惠页：https://www.aliyun.com/activity/new
   - 选择「轻量应用服务器」或「云服务器 ECS」

4. **选择配置**
   ```
   地域：选择离您最近的（如：华东-上海）
   镜像：Ubuntu 22.04 64位
   实例规格：2核2G 或 2核4G
   系统盘：40GB SSD
   带宽：按固定带宽 3Mbps（或按量付费）
   购买时长：按需选择（年付更优惠）
   ```

5. **设置登录密码**
   - 设置 root 密码（记住它！）
   - 或选择 SSH 密钥对登录

6. **完成支付**
   - 确认订单并支付
   - 支付成功后等待1-2分钟，服务器就绑定好了

### 1.3 腾讯云购买流程

1. **访问腾讯云官网**
   - 打开 https://cloud.tencent.com/
   - 注册/登录账号

2. **实名认证**
   - 账号中心 → 实名认证

3. **购买服务器**
   - 新用户优惠：https://cloud.tencent.com/act/new
   - 选择「轻量应用服务器」或「云服务器 CVM」

4. **选择配置**（同阿里云，选择 Ubuntu 22.04）

5. **设置密码并支付**

### 1.4 获取服务器信息

购买完成后，在控制台找到以下信息（很重要！）：

```
公网 IP 地址：xxx.xxx.xxx.xxx  （记下来）
登录用户名：root
登录密码：您设置的密码
```

---

## 第二步：连接服务器

### 2.1 Mac/Linux 用户

打开终端，输入：

```bash
ssh root@你的服务器IP
```

首次连接会提示：
```
Are you sure you want to continue connecting (yes/no)?
```
输入 `yes` 然后回车，接着输入密码。

### 2.2 Windows 用户

**方法1：使用 PowerShell**
```powershell
ssh root@你的服务器IP
```

**方法2：使用工具**
- 下载 [MobaXterm](https://mobaxterm.mobatek.net/)（免费）
- 或 [Xshell](https://www.xshell.com/zh/free-for-home-school/)（个人免费）
- 新建 SSH 连接，填入 IP、用户名 root、密码

### 2.3 连接成功标志

看到类似以下提示表示连接成功：

```
Welcome to Ubuntu 22.04 LTS
root@your-server:~#
```

---

## 第三步：配置服务器环境

连接成功后，依次执行以下命令：

### 3.1 更新系统

```bash
apt update && apt upgrade -y
```

### 3.2 安装 Docker

```bash
# 一键安装 Docker
curl -fsSL https://get.docker.com | sh

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 3.3 配置防火墙

```bash
# 开放必要端口
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw allow 8000/tcp  # API（测试用，上线后可关闭）
ufw enable          # 启用防火墙

# 确认
ufw status
```

### 3.4 创建应用目录

```bash
mkdir -p /opt/Clothing_Recycle
cd /opt/Clothing_Recycle
```

---

## 第四步：上传代码到服务器

### 方法1：使用 scp 命令（推荐）

在**本地电脑**执行（新开一个终端窗口）：

```bash
# 上传整个项目
scp -r /Users/nicolas/work/code/Clothing_Recycle/* root@你的服务器IP:/opt/Clothing_Recycle/
```

### 方法2：使用 Git

如果代码已推送到 Git 仓库：

```bash
# 在服务器上执行
cd /opt
git clone 你的仓库地址 Clothing_Recycle
```

### 方法3：使用 SFTP 工具

- Mac: 使用 Cyberduck（免费）
- Windows: 使用 WinSCP 或 MobaXterm 自带的 SFTP

---

## 第五步：配置环境变量

在服务器上执行：

```bash
cd /opt/Clothing_Recycle/backend

# 创建配置文件
cp env.example.txt .env

# 编辑配置
nano .env
```

修改以下内容：

```ini
# 改为生产环境
APP_ENV=production
DEBUG=false

# 生成随机密钥（复制下面命令的输出结果填入）
# openssl rand -hex 32
SECRET_KEY=这里填入生成的随机字符串
JWT_SECRET_KEY=这里填入另一个生成的随机字符串

# 微信小程序配置（重要！）
WECHAT_APPID=你的小程序AppID
WECHAT_SECRET=你的小程序AppSecret
```

**如何获取 AppSecret**：
1. 登录 https://mp.weixin.qq.com/
2. 开发管理 → 开发设置 → AppSecret → 重置/查看

保存文件：`Ctrl+O` 回车，然后 `Ctrl+X` 退出。

---

## 第六步：启动后端服务

```bash
cd /opt/Clothing_Recycle/backend/deploy

# 给脚本执行权限
chmod +x deploy.sh

# 一键部署
bash deploy.sh
```

等待几分钟，看到以下信息表示成功：

```
==========================================
  ✅ 部署完成！
==========================================

API 地址: http://xxx.xxx.xxx.xxx:8000
API 文档: http://xxx.xxx.xxx.xxx:8000/docs
```

### 验证部署

```bash
# 测试 API 是否正常
curl http://localhost:8000/health
```

应该返回：`{"status":"healthy"}`

在浏览器访问：`http://你的服务器IP:8000/docs`
能看到 API 文档页面表示成功！

---

## 第七步：配置域名（推荐）

### 7.1 购买域名

**推荐平台**：
- 阿里云万网：https://wanwang.aliyun.com/
- 腾讯云 DNSPod：https://dnspod.cloud.tencent.com/

**购买流程**：
1. 搜索想要的域名（如 `yourname.com`）
2. 加入购物车并支付
3. 完成域名实名认证

### 7.2 添加域名解析

1. 进入域名管理控制台
2. 找到你的域名，点击「解析」
3. 添加一条 A 记录：

```
记录类型：A
主机记录：api（表示 api.你的域名.com）
记录值：你的服务器IP
TTL：默认
```

等待 5-10 分钟生效，然后测试：

```bash
ping api.你的域名.com
```

能 ping 通表示解析成功。

### 7.3 申请 SSL 证书（HTTPS 必须）

**阿里云免费证书**：

1. 访问 https://yundun.console.aliyun.com/?p=cas
2. 点击「SSL 证书」→「免费证书」→「创建证书」
3. 填写域名：`api.你的域名.com`
4. 验证方式：选择「DNS 验证」
5. 按提示添加 DNS 解析记录
6. 等待审核（约 5-30 分钟）
7. 审核通过后下载证书（选择 Nginx 格式）

**腾讯云免费证书**：

1. 访问 https://console.cloud.tencent.com/ssl
2. 申请免费证书
3. 流程类似阿里云

### 7.4 配置 HTTPS

```bash
# 在服务器上创建证书目录
mkdir -p /opt/Clothing_Recycle/backend/deploy/nginx/ssl

# 将下载的证书上传到此目录
# 证书文件重命名为：
#   fullchain.pem（证书文件）
#   privkey.pem（私钥文件）
```

**在本地电脑上传证书**：

```bash
# 假设证书下载在本地 ~/Downloads/ 目录
scp ~/Downloads/你的证书文件.pem root@服务器IP:/opt/Clothing_Recycle/backend/deploy/nginx/ssl/fullchain.pem
scp ~/Downloads/你的私钥文件.key root@服务器IP:/opt/Clothing_Recycle/backend/deploy/nginx/ssl/privkey.pem
```

### 7.5 修改 Nginx 配置

```bash
cd /opt/Clothing_Recycle/backend/deploy/nginx
nano nginx.conf
```

找到这一行，改为你的域名：
```
server_name api.yourdomain.com;  # 改为你的域名
```

### 7.6 启用 HTTPS

```bash
cd /opt/Clothing_Recycle/backend/deploy

# 停止简化版
docker-compose -f docker-compose-simple.yml down

# 启动完整版（含 Nginx）
docker-compose up -d
```

验证 HTTPS：
- 访问 `https://api.你的域名.com/health`
- 应该返回 `{"status":"healthy"}`

---

## 第八步：配置小程序

### 8.1 配置服务器域名

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入「开发管理」→「开发设置」→「服务器域名」
3. 点击「修改」，添加：

```
request合法域名：https://api.你的域名.com
uploadFile合法域名：https://api.你的域名.com
downloadFile合法域名：https://api.你的域名.com
```

4. 点击「保存并提交」

> ⚠️ 每月只能修改 5 次，请确认无误后再提交

### 8.2 修改小程序代码

编辑 `miniprogram/config/index.js`：

```javascript
// 改为生产环境
const ENV = 'production';

const config = {
  development: {
    API_BASE_URL: 'http://localhost:8000/api/v1',
    // ...
  },
  
  // 修改这里
  production: {
    API_BASE_URL: 'https://api.你的域名.com/api/v1',  // 改为你的域名
    WS_URL: 'wss://api.你的域名.com/ws',
    DEBUG: false
  }
};
```

### 8.3 编译测试

1. 在微信开发者工具中，**取消**勾选「不校验合法域名」
2. 点击「编译」
3. 测试各项功能

---

## 第九步：验证完整流程

### 9.1 测试登录

1. 在小程序中点击「登录」
2. 查看是否正常获取用户信息

### 9.2 测试扫码功能

在服务器上生成测试二维码：

```bash
cd /opt/Clothing_Recycle/backend

# 进入容器
docker exec -it clothing-recycle-api bash

# 运行测试脚本
python scripts/generate_test_qrcode.py
```

按提示输入设备密钥（从数据库初始化时的输出中获取）。

### 9.3 完整测试

1. 生成测试二维码
2. 将二维码内容生成图片（使用 https://cli.im/text）
3. 用小程序扫码
4. 确认领取
5. 查看钱包余额

---

## 🎉 恭喜！部署完成！

### 常用运维命令速查

```bash
# 进入项目目录
cd /opt/Clothing_Recycle/backend/deploy

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f api

# 重启服务
docker-compose restart api

# 停止所有服务
docker-compose down

# 更新代码后重新部署
docker-compose up -d --build
```

### 遇到问题？

| 问题 | 解决方案 |
|-----|---------|
| 小程序提示「网络请求失败」 | 检查域名是否配置正确，HTTPS 证书是否有效 |
| 登录失败 | 检查 AppID 和 AppSecret 是否正确 |
| 数据库连接失败 | 运行 `docker-compose logs mysql` 查看日志 |
| 502 错误 | 运行 `docker-compose logs api` 查看后端日志 |

### 下一步

- [ ] 配置数据库定期备份
- [ ] 配置服务监控告警
- [ ] 提交小程序审核上线

