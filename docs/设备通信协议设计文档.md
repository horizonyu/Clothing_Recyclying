# 智能旧衣回收箱 4G设备-后台通信协议设计文档

## 1. 概述

本文档定义了智能旧衣回收箱 4G 硬件设备与后台服务之间的通信协议规范，基于《旧物回收通信协议.docx》设计。

### 1.1 通信方式

| 通信方式 | 用途 | 协议 | 频率 |
|---------|------|------|------|
| **设备主动上报** | 常规状态上报，含传感器、位置、摄像头数据 | HTTP/HTTPS POST | 状态变化时 |
| **设备心跳上报** | 设备心跳保活、时间同步 | HTTP/HTTPS POST | 每8小时1次 |
| **小程序扫码上报** | 用户扫码后，小程序上报二维码数据到后台 | HTTP/HTTPS POST | 事件触发 |
| **后台下发指令** | 时间同步、主动查询设备状态 | HTTP/HTTPS POST | 按需 |

### 1.2 通信流程

```
┌─────────────────────────────────────────────────────────────┐
│                    设备通信流程图                              │
└─────────────────────────────────────────────────────────────┘

【方式一：设备主动状态上报】
设备检测状态变化 → 上报状态报文 → 后台验证(MD5校验) → 更新设备状态 → 返回ACK应答

【方式二：设备心跳上报】
每8小时定时触发 → 发送心跳报文 → 后台验证(MD5校验) → 更新在线状态 → 下发时间同步指令

【方式三：小程序扫码上报】
用户投递完成 → 硬件生成二维码 → 用户微信扫码 → 小程序解析并上报 → 后台验证 → 创建订单

【方式四：后台主动下发】
后台发起查询 → 下发查询指令 → 设备接收并响应 → 上报当前状态
```

---

## 2. 报文格式规范

### 2.1 报文结构

所有报文遵循以下格式：

```
包头(0x6868) + JSON数据体 + 包尾(0x1616)
```

| 组成部分 | 值 | 说明 |
|---------|------|------|
| 包头 | `0x6868` | 固定字符串标识报文开始 |
| JSON数据体 | `{...}` | 具体业务数据 |
| 包尾 | `0x1616` | 固定字符串标识报文结束 |

### 2.2 通用JSON字段

```json
{
  "msg_type": "device_status_report",
  "device_id": "DEV_202601300001",
  "timestamp": "2026-01-30 10:00:00",
  "check_code": "md5_hash_value",
  "data": { ... }
}
```

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| `msg_type` | string | 是 | 报文类型 |
| `device_id` | string | 是 | 设备ID，格式 `DEV_YYYYMMDDXXXX` |
| `timestamp` | string | 是 | 时间戳，格式 `yyyy-MM-dd HH:mm:ss` |
| `check_code` | string | 是 | MD5校验码 |
| `data` | object | 否 | 业务数据（部分报文无data字段） |

### 2.3 设备ID格式

```
DEV_YYYYMMDDXXXX

示例：DEV_202601300001
- DEV_：固定前缀
- 20260130：日期
- 0001：设备序号
```

### 2.4 MD5校验码计算规则

```
校验范围：包头 + JSON数据体中除check_code外的所有字段拼接字符串
校验算法：MD5，32位小写

步骤：
1. 从JSON数据体中取出除check_code外的所有字段
2. 按key排序后序列化为紧凑JSON字符串
3. 拼接：包头(0x6868) + 排序后的JSON字符串
4. 计算MD5得到32位小写哈希值
```

**Python示例**：
```python
import hashlib, json

def calculate_check_code(packet_data: dict) -> str:
    data_copy = {k: v for k, v in packet_data.items() if k != "check_code"}
    json_str = json.dumps(data_copy, ensure_ascii=False, separators=(',', ':'))
    check_str = "0x6868" + json_str
    return hashlib.md5(check_str.encode('utf-8')).hexdigest()
```

---

## 3. 设备主动上报报文

### 3.1 常规状态上报 (device_status_report)

设备检测到状态变化时主动上报。

**JSON数据体**：
```json
{
  "msg_type": "device_status_report",
  "device_id": "DEV_202601300001",
  "timestamp": "2026-01-30 10:00:00",
  "check_code": "abc123...",
  "data": {
    "battery_level": 85,
    "location": {
      "longitude": 113.9423,
      "latitude": 22.5431,
      "address": "广东省深圳市宝安区XX街道XX路"
    },
    "smoke_sensor_status": 0,
    "recycle_bin_full": 0,
    "delivery_window_open": 0,
    "is_using": 0,
    "camera_data": {
      "camera_1": ["base64_image_1", "base64_image_2", "base64_image_3"],
      "camera_2": ["base64_image_1", "base64_image_2", "base64_image_3"]
    }
  }
}
```

**data字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|-----|------|------|------|
| `battery_level` | int | 是 | 电池电量百分比(0-100) |
| `location.longitude` | float | 是 | 经度，保留4位小数 |
| `location.latitude` | float | 是 | 纬度，保留4位小数 |
| `location.address` | string | 是 | 设备地址 |
| `smoke_sensor_status` | int | 是 | 烟感状态: 0-正常, 1-告警 |
| `recycle_bin_full` | int | 是 | 仓体满空: 0-未满, 1-已满 |
| `delivery_window_open` | int | 是 | 投放窗口: 0-关闭, 1-打开 |
| `is_using` | int | 是 | 使用状态: 0-无人使用, 1-有人使用 |
| `camera_data.camera_1` | array | 否 | 摄像头1图片，Base64编码（最多3张） |
| `camera_data.camera_2` | array | 否 | 摄像头2图片，Base64编码（最多3张） |

### 3.2 心跳包上报 (heartbeat_report)

设备每8小时上报一次心跳包，无状态变化仅保活。

**JSON数据体**：
```json
{
  "msg_type": "heartbeat_report",
  "device_id": "DEV_202601300001",
  "timestamp": "2026-01-30 10:00:00",
  "check_code": "abc123..."
}
```

> 心跳包无 `data` 字段。

---

## 4. 后台下发报文

### 4.1 时间同步指令 (time_sync)

后台收到设备心跳后下发时间同步。

**JSON数据体**：
```json
{
  "msg_type": "time_sync",
  "device_id": "DEV_202601300001",
  "timestamp": "2026-01-30 10:00:01",
  "check_code": "abc123...",
  "data": {
    "standard_time": "2026-01-30 10:00:01"
  }
}
```

### 4.2 后台应答 (server_ack)

后台处理完设备上报后，返回应答报文。

**JSON数据体**：
```json
{
  "msg_type": "server_ack",
  "device_id": "DEV_202601300001",
  "timestamp": "2026-01-30 10:00:01",
  "check_code": "abc123...",
  "data": {
    "reply_msg_type": "device_status_report",
    "ack_code": 0,
    "ack_desc": "接收成功"
  }
}
```

| 字段 | 类型 | 说明 |
|-----|------|------|
| `reply_msg_type` | string | 被应答的报文类型 |
| `ack_code` | int | 应答码: 0-接收成功, 1-接收失败 |
| `ack_desc` | string | 应答描述 |

### 4.3 主动查询设备状态 (query_device_status)

后台主动下发查询指令，设备收到后上报状态。

**JSON数据体**：
```json
{
  "msg_type": "query_device_status",
  "device_id": "DEV_202601300001",
  "timestamp": "2026-01-30 10:00:00",
  "check_code": "abc123..."
}
```

---

## 5. 小程序扫码上报

### 5.1 流程说明

1. 用户投递衣物完成
2. 硬件根据传感器和摄像头生成上报信息
3. 硬件将信息编码为二维码并显示
4. 用户使用微信扫一扫扫描二维码
5. 小程序获取二维码数据并向后台API上报
6. 后台验证报文完整性（MD5校验）
7. 后台解析关键参数，创建订单
8. 用户确认领取

### 5.2 二维码内容

二维码内容为完整的设备状态上报报文（含包头包尾），即：

```
0x6868{"msg_type":"device_status_report","device_id":"DEV_202601300001","timestamp":"2026-01-30 10:30:00","check_code":"...","data":{...}}0x1616
```

### 5.3 API接口

```
POST /api/v1/order/scan
```

小程序解析二维码后，将报文数据提交到后台。

---

## 6. 安全机制

### 6.1 报文完整性校验

1. **包头/包尾验证**：验证报文是否以 `0x6868` 开头、`0x1616` 结尾
2. **MD5校验码**：验证JSON数据体的MD5校验码是否正确
3. **校验失败处理**：直接丢弃报文，不回复应答

### 6.2 时间戳验证

- 设备时间戳必须在服务器时间 ±5分钟 内
- 超出范围的报文直接丢弃
- 后台通过时间同步指令校正设备时钟

### 6.3 设备认证

- 设备必须在数据库中注册
- 未注册设备的报文直接丢弃

---

## 7. API接口定义

### 7.1 设备状态上报

```
POST /api/v1/device/report
Content-Type: application/json
```

**请求体**：设备状态上报JSON数据（不含包头包尾）

**响应**：server_ack应答JSON

### 7.2 设备心跳上报

```
POST /api/v1/device/heartbeat
Content-Type: application/json
```

**请求体**：心跳报文JSON数据

**响应**：
- 成功时返回 time_sync 时间同步指令
- 同时返回 server_ack 应答

### 7.3 后台主动查询（管理用）

```
POST /api/v1/device/command/query_status?device_id=DEV_202601300001
```

**响应**：query_device_status 指令JSON

### 7.4 后台时间同步（管理用）

```
POST /api/v1/device/command/time_sync?device_id=DEV_202601300001
```

**响应**：time_sync 指令JSON

---

## 8. 设备状态判断

| 状态 | 条件 |
|------|------|
| 在线(online) | 收到心跳或状态上报 |
| 离线(offline) | 超过24小时未收到心跳 |
| 告警 | 烟感状态=1 |
| 满载 | 仓体满空=1 |
| 使用中 | is_using=1 |

---

## 9. 数据模型

### 9.1 设备表 (devices) 扩展字段

| 字段 | 类型 | 说明 |
|-----|------|------|
| `battery_level` | int | 电池电量(0-100) |
| `smoke_sensor_status` | int | 烟感状态(0/1) |
| `recycle_bin_full` | int | 仓体满载(0/1) |
| `delivery_window_open` | int | 投放窗口(0/1) |
| `is_using` | int | 使用状态(0/1) |
| `firmware_version` | string | 固件版本 |

---

**文档版本**：v2.0  
**最后更新**：2026-02-08  
**参考文档**：《旧物回收通信协议.docx》
