# æ•°æ®åº“è¡¨ç»“æ„è¯´æ˜

æœ¬æ–‡æ¡£æè¿°æ™ºèƒ½æ—§è¡£å›æ”¶ç®±ç³»ç»Ÿçš„æ•°æ®åº“è¡¨ç»“æ„åŠå…¶å…³è”å…³ç³»ã€‚

---

## ğŸ“Š æ•°æ®è¡¨å…³è”å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®è¡¨å…³è”å…³ç³»                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    devices    â”‚                    â”‚       users       â”‚
    â”‚   (è®¾å¤‡è¡¨)     â”‚                    â”‚     (ç”¨æˆ·è¡¨)       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ device_id  PK â”‚â—„â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–ºâ”‚ user_id       PK  â”‚
    â”‚ name          â”‚      â”‚      â”‚      â”‚ openid            â”‚
    â”‚ address       â”‚      â”‚      â”‚      â”‚ nickname          â”‚
    â”‚ device_secret â”‚      â”‚      â”‚      â”‚ phone             â”‚
    â”‚ unit_price    â”‚      â”‚      â”‚      â”‚ balance           â”‚
    â”‚ status        â”‚      â”‚      â”‚      â”‚ total_weight      â”‚
    â”‚ ...           â”‚      â”‚      â”‚      â”‚ total_carbon      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚      â”‚               â–²
                           â”‚      â”‚               â”‚
                           â”‚      â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      delivery_orders (æŠ•é€’è®¢å•è¡¨)                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  order_id      PK   è®¢å•ID                                          â”‚
    â”‚  voucher_id    UK   æŠ•é€’å‡­è¯IDï¼ˆäºŒç»´ç ä¸­çš„å‡­è¯ï¼‰                        â”‚
    â”‚  device_id     FK   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º devices.device_id  â”‚
    â”‚  user_id       FK   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º users.user_id      â”‚
    â”‚  weight             é‡é‡(kg)                                        â”‚
    â”‚  unit_price         å•ä»·(å…ƒ/kg)                                     â”‚
    â”‚  amount             é‡‘é¢(å…ƒ)                                        â”‚
    â”‚  carbon_reduction   ç¢³å‡æ’é‡                                        â”‚
    â”‚  status             çŠ¶æ€(0å¾…é¢†å–/1å·²é¢†å–/2å·²è¿‡æœŸ/3å¼‚å¸¸)                â”‚
    â”‚  ...                                                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â”‚ order_id
                                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     wallet_records (é’±åŒ…è®°å½•è¡¨)                       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  record_id     PK   è®°å½•ID                                          â”‚
    â”‚  user_id       FK   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º users.user_id      â”‚
    â”‚  order_id      FK   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º delivery_orders    â”‚
    â”‚  type               äº¤æ˜“ç±»å‹(income/withdraw/refund)                 â”‚
    â”‚  amount             é‡‘é¢                                            â”‚
    â”‚  balance_before     äº¤æ˜“å‰ä½™é¢                                       â”‚
    â”‚  balance_after      äº¤æ˜“åä½™é¢                                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ å„è¡¨è¯¦ç»†è¯´æ˜

### 1. users - ç”¨æˆ·è¡¨

å­˜å‚¨å¾®ä¿¡å°ç¨‹åºç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€é’±åŒ…ä½™é¢å’Œç»Ÿè®¡æ•°æ®ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-----|------|------|------|
| `id` | Integer | PK, AUTO_INCREMENT | è‡ªå¢ä¸»é”® |
| `user_id` | String(32) | UNIQUE, NOT NULL | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `openid` | String(64) | UNIQUE, NOT NULL | å¾®ä¿¡OpenID |
| `unionid` | String(64) | NULL | å¾®ä¿¡UnionID |
| `nickname` | String(64) | NULL | ç”¨æˆ·æ˜µç§° |
| `avatar_url` | String(500) | NULL | å¤´åƒURL |
| `phone` | String(20) | NULL | æ‰‹æœºå· |
| `real_name` | String(32) | NULL | çœŸå®å§“å |
| `id_card` | String(32) | NULL | èº«ä»½è¯å·(åŠ å¯†å­˜å‚¨) |
| `is_verified` | Boolean | DEFAULT FALSE | æ˜¯å¦å®åè®¤è¯ |
| `balance` | Float | DEFAULT 0.0 | é’±åŒ…ä½™é¢ |
| `frozen_balance` | Float | DEFAULT 0.0 | å†»ç»“é‡‘é¢ |
| `points` | Integer | DEFAULT 0 | ç§¯åˆ† |
| `total_weight` | Float | DEFAULT 0.0 | ç´¯è®¡æŠ•é€’é‡é‡(kg) |
| `total_carbon` | Float | DEFAULT 0.0 | ç´¯è®¡ç¢³å‡æ’(kg) |
| `total_count` | Integer | DEFAULT 0 | ç´¯è®¡æŠ•é€’æ¬¡æ•° |
| `created_at` | DateTime | AUTO | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DateTime | AUTO | æ›´æ–°æ—¶é—´ |
| `last_login_at` | DateTime | NULL | æœ€åç™»å½•æ—¶é—´ |
| `status` | Integer | DEFAULT 1 | çŠ¶æ€: 0-ç¦ç”¨, 1-æ­£å¸¸ |

---

### 2. devices - è®¾å¤‡è¡¨

å­˜å‚¨å›æ”¶ç®±è®¾å¤‡çš„åŸºæœ¬ä¿¡æ¯ã€é…ç½®å’Œå®æ—¶çŠ¶æ€ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-----|------|------|------|
| `id` | Integer | PK, AUTO_INCREMENT | è‡ªå¢ä¸»é”® |
| `device_id` | String(32) | UNIQUE, NOT NULL | è®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ DEV001ï¼‰ |
| `name` | String(100) | NOT NULL | è®¾å¤‡åç§° |
| `address` | String(255) | NULL | è®¾å¤‡åœ°å€ |
| `latitude` | Float | NULL | çº¬åº¦ |
| `longitude` | Float | NULL | ç»åº¦ |
| `device_secret` | String(64) | NOT NULL | è®¾å¤‡å¯†é’¥ï¼ˆç”¨äºç­¾åéªŒè¯ï¼‰ |
| `unit_price` | Float | DEFAULT 0.30 | å›æ”¶å•ä»·(å…ƒ/kg) |
| `min_weight` | Float | DEFAULT 0.1 | æœ€å°ç§°é‡(kg) |
| `status` | String(20) | DEFAULT 'offline' | çŠ¶æ€: online/offline/maintenance |
| `last_heartbeat` | DateTime | NULL | æœ€åå¿ƒè·³æ—¶é—´ |
| `capacity_percent` | Integer | DEFAULT 0 | å®¹é‡ç™¾åˆ†æ¯” |
| `current_weight` | Float | DEFAULT 0.0 | å½“å‰é‡é‡(kg) |
| `temperature` | Float | NULL | æ¸©åº¦ |
| `humidity` | Float | NULL | æ¹¿åº¦ |
| `smoke_level` | Float | NULL | çƒŸé›¾æµ“åº¦ |
| `created_at` | DateTime | AUTO | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DateTime | AUTO | æ›´æ–°æ—¶é—´ |

---

### 3. delivery_orders - æŠ•é€’è®¢å•è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰

å­˜å‚¨æ¯æ¬¡æŠ•é€’çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡è¡¨ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-----|------|------|------|
| `id` | Integer | PK, AUTO_INCREMENT | è‡ªå¢ä¸»é”® |
| `order_id` | String(32) | UNIQUE, NOT NULL | è®¢å•ID |
| `voucher_id` | String(32) | UNIQUE, NOT NULL | æŠ•é€’å‡­è¯IDï¼ˆäºŒç»´ç ä¸­åŒ…å«ï¼‰ |
| `device_id` | String(32) | NOT NULL, FK | è®¾å¤‡ID â†’ devices.device_id |
| `device_name` | String(100) | NULL | è®¾å¤‡åç§°ï¼ˆå†—ä½™å­—æ®µï¼‰ |
| `device_address` | String(255) | NULL | è®¾å¤‡åœ°å€ï¼ˆå†—ä½™å­—æ®µï¼‰ |
| `user_id` | String(32) | NULL, FK | ç”¨æˆ·ID â†’ users.user_idï¼ˆé¢†å–æ—¶ç»‘å®šï¼‰ |
| `weight` | Float | NOT NULL | é‡é‡(kg) |
| `unit_price` | Float | NOT NULL | å•ä»·(å…ƒ/kg) |
| `amount` | Float | NOT NULL | é‡‘é¢(å…ƒ) |
| `carbon_reduction` | Float | DEFAULT 0.0 | ç¢³å‡æ’(kg) |
| `points_earned` | Integer | DEFAULT 0 | è·å¾—ç§¯åˆ† |
| `signature` | String(128) | NULL | æ•°æ®ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰ |
| `status` | Integer | DEFAULT 0 | çŠ¶æ€: 0-å¾…é¢†å–, 1-å·²é¢†å–, 2-å·²è¿‡æœŸ, 3-å¼‚å¸¸ |
| `door_open_time` | DateTime | NULL | å¼€é—¨æ—¶é—´ |
| `door_close_time` | DateTime | NULL | å…³é—¨æ—¶é—´ |
| `qrcode_time` | DateTime | NULL | äºŒç»´ç ç”Ÿæˆæ—¶é—´ |
| `qrcode_expire_time` | DateTime | NULL | äºŒç»´ç è¿‡æœŸæ—¶é—´ |
| `scan_time` | DateTime | NULL | æ‰«ç æ—¶é—´ |
| `claim_time` | DateTime | NULL | é¢†å–æ—¶é—´ |
| `created_at` | DateTime | AUTO | åˆ›å»ºæ—¶é—´ |
| `updated_at` | DateTime | AUTO | æ›´æ–°æ—¶é—´ |
| `image_url` | String(500) | NULL | æŠ•é€’å›¾ç‰‡URL |
| `video_url` | String(500) | NULL | æŠ•é€’è§†é¢‘URL |

**è®¢å•çŠ¶æ€è¯´æ˜ï¼š**

| çŠ¶æ€å€¼ | å«ä¹‰ | è¯´æ˜ |
|-------|------|------|
| 0 | å¾…é¢†å– | ç”¨æˆ·å·²æŠ•é€’ï¼Œæ‰«ç åç­‰å¾…ç¡®è®¤é¢†å– |
| 1 | å·²é¢†å– | ç”¨æˆ·å·²ç¡®è®¤é¢†å–ï¼Œé‡‘é¢å·²å…¥è´¦ |
| 2 | å·²è¿‡æœŸ | äºŒç»´ç è¶…æ—¶æœªæ‰«ææˆ–æœªé¢†å– |
| 3 | å¼‚å¸¸ | ç­¾åéªŒè¯å¤±è´¥æˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µ |

---

### 4. wallet_records - é’±åŒ…è®°å½•è¡¨

å­˜å‚¨ç”¨æˆ·é’±åŒ…çš„æ¯ä¸€ç¬”äº¤æ˜“æµæ°´ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|-----|------|------|------|
| `id` | Integer | PK, AUTO_INCREMENT | è‡ªå¢ä¸»é”® |
| `record_id` | String(32) | UNIQUE, NOT NULL | è®°å½•ID |
| `user_id` | String(32) | NOT NULL, FK | ç”¨æˆ·ID â†’ users.user_id |
| `type` | String(20) | NOT NULL | äº¤æ˜“ç±»å‹ |
| `amount` | Float | NOT NULL | äº¤æ˜“é‡‘é¢ |
| `balance_before` | Float | NOT NULL | äº¤æ˜“å‰ä½™é¢ |
| `balance_after` | Float | NOT NULL | äº¤æ˜“åä½™é¢ |
| `order_id` | String(32) | NULL, FK | å…³è”è®¢å•ID â†’ delivery_orders.order_id |
| `remark` | String(255) | NULL | å¤‡æ³¨ |
| `created_at` | DateTime | AUTO | åˆ›å»ºæ—¶é—´ |

**äº¤æ˜“ç±»å‹è¯´æ˜ï¼š**

| ç±»å‹ | å«ä¹‰ | è¯´æ˜ |
|-----|------|------|
| income | æ”¶å…¥ | æŠ•é€’è¡£ç‰©è·å¾—çš„æ”¶å…¥ |
| withdraw | æç° | ç”¨æˆ·æç°åˆ°å¾®ä¿¡/æ”¯ä»˜å® |
| refund | é€€æ¬¾ | å¼‚å¸¸è®¢å•é€€æ¬¾ |

---

## ğŸ”— å…³è”å…³ç³»æ€»ç»“

| å…³ç³» | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `users` â†” `delivery_orders` | ä¸€å¯¹å¤š | ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šæ¡æŠ•é€’è®°å½• |
| `devices` â†” `delivery_orders` | ä¸€å¯¹å¤š | ä¸€å°è®¾å¤‡å¯ä»¥æœ‰å¤šæ¡æŠ•é€’è®°å½• |
| `users` â†” `wallet_records` | ä¸€å¯¹å¤š | ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šæ¡é’±åŒ…æµæ°´ |
| `delivery_orders` â†” `wallet_records` | ä¸€å¯¹ä¸€ | æ¯æ¬¡é¢†å–äº§ç”Ÿä¸€æ¡æ”¶å…¥è®°å½• |

---

## ğŸ“ ä¸šåŠ¡æµç¨‹ä¸­çš„æ•°æ®æµå‘

### å®Œæ•´æŠ•é€’é¢†å–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ä¸šåŠ¡æµç¨‹æ•°æ®æµå‘                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·æŠ•é€’è¡£ç‰©
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¾å¤‡ç«¯                                                                      â”‚
â”‚  â€¢ æ£€æµ‹è¡£ç‰©é‡é‡                                                              â”‚
â”‚  â€¢ æ ¹æ® devices.unit_price è®¡ç®—é‡‘é¢                                          â”‚
â”‚  â€¢ ç”ŸæˆäºŒç»´ç ï¼ˆå« voucher_idã€weightã€amountã€signatureï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
2. ç”¨æˆ·æ‰«ç 
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯éªŒè¯                                                                    â”‚
â”‚  â€¢ éªŒè¯ç­¾åï¼ˆä½¿ç”¨ devices.device_secretï¼‰                                    â”‚
â”‚  â€¢ æ£€æŸ¥äºŒç»´ç æ˜¯å¦è¿‡æœŸ                                                        â”‚
â”‚  â€¢ åˆ›å»º delivery_orders è®°å½•ï¼ˆstatus=0 å¾…é¢†å–ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
3. ç”¨æˆ·ç¡®è®¤é¢†å–
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯å¤„ç†                                                                    â”‚
â”‚  â€¢ æ›´æ–° delivery_ordersï¼ˆstatus=1ï¼Œç»‘å®š user_idï¼Œè®°å½• claim_timeï¼‰           â”‚
â”‚  â€¢ åˆ›å»º wallet_recordsï¼ˆtype=incomeï¼Œè®°å½•ä½™é¢å˜åŒ–ï¼‰                           â”‚
â”‚  â€¢ æ›´æ–° usersï¼ˆbalance += amountï¼Œtotal_weight += weight ç­‰ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®å˜æ›´ç¤ºä¾‹

å‡è®¾ç”¨æˆ·æŠ•é€’äº† 3.5kg è¡£ç‰©ï¼Œå•ä»· 0.30 å…ƒ/kgï¼š

**1. åˆ›å»ºè®¢å•ï¼ˆæ‰«ç æ—¶ï¼‰**
```sql
INSERT INTO delivery_orders 
  (order_id, voucher_id, device_id, weight, unit_price, amount, carbon_reduction, status)
VALUES 
  ('ORD20260109001', 'V20260109DEV001001', 'DEV001', 3.5, 0.30, 1.05, 6.3, 0);
```

**2. é¢†å–æˆåŠŸåæ›´æ–°**
```sql
-- æ›´æ–°è®¢å•çŠ¶æ€
UPDATE delivery_orders 
SET status = 1, user_id = 'U123456', claim_time = NOW()
WHERE order_id = 'ORD20260109001';

-- è®°å½•é’±åŒ…æµæ°´
INSERT INTO wallet_records 
  (record_id, user_id, type, amount, balance_before, balance_after, order_id)
VALUES 
  ('WR20260109001', 'U123456', 'income', 1.05, 10.00, 11.05, 'ORD20260109001');

-- æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
UPDATE users 
SET balance = balance + 1.05,
    total_weight = total_weight + 3.5,
    total_carbon = total_carbon + 6.3,
    total_count = total_count + 1
WHERE user_id = 'U123456';
```

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢ç”¨æˆ·æŠ•é€’å†å²
```sql
SELECT o.*, d.name as device_name
FROM delivery_orders o
LEFT JOIN devices d ON o.device_id = d.device_id
WHERE o.user_id = 'U123456'
ORDER BY o.created_at DESC;
```

### æŸ¥è¯¢ç”¨æˆ·é’±åŒ…æµæ°´
```sql
SELECT r.*, o.weight, o.device_id
FROM wallet_records r
LEFT JOIN delivery_orders o ON r.order_id = o.order_id
WHERE r.user_id = 'U123456'
ORDER BY r.created_at DESC;
```

### ç»Ÿè®¡è®¾å¤‡å›æ”¶æ•°æ®
```sql
SELECT 
    device_id,
    COUNT(*) as total_orders,
    SUM(weight) as total_weight,
    SUM(amount) as total_amount,
    SUM(carbon_reduction) as total_carbon
FROM delivery_orders
WHERE status = 1
GROUP BY device_id;
```

### æŸ¥è¯¢å¾…é¢†å–è®¢å•
```sql
SELECT * FROM delivery_orders
WHERE status = 0 
  AND qrcode_expire_time > NOW()
ORDER BY created_at DESC;
```

---

## ğŸ“Š ç´¢å¼•è®¾è®¡

ä¸ºæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå„è¡¨å»ºç«‹äº†ä»¥ä¸‹ç´¢å¼•ï¼š

| è¡¨å | ç´¢å¼•å­—æ®µ | ç´¢å¼•ç±»å‹ | ç”¨é€” |
|-----|---------|---------|------|
| users | user_id | UNIQUE | ç”¨æˆ·æŸ¥è¯¢ |
| users | openid | UNIQUE | å¾®ä¿¡ç™»å½• |
| devices | device_id | UNIQUE | è®¾å¤‡æŸ¥è¯¢ |
| delivery_orders | order_id | UNIQUE | è®¢å•æŸ¥è¯¢ |
| delivery_orders | voucher_id | UNIQUE | äºŒç»´ç éªŒè¯ |
| delivery_orders | device_id | INDEX | æŒ‰è®¾å¤‡æŸ¥è¯¢ |
| delivery_orders | user_id | INDEX | æŒ‰ç”¨æˆ·æŸ¥è¯¢ |
| delivery_orders | status | INDEX | æŒ‰çŠ¶æ€ç­›é€‰ |
| wallet_records | record_id | UNIQUE | è®°å½•æŸ¥è¯¢ |
| wallet_records | user_id | INDEX | ç”¨æˆ·æµæ°´æŸ¥è¯¢ |
