# 设备通信协议实现说明

## 📋 实现概述

已根据《旧物回收通信协议.docx》完成 4G 设备与后台服务的通信协议实现。

## ✅ 已实现功能

### 1. 二维码方式（已存在）

- ✅ 二维码生成逻辑（硬件端）
- ✅ 二维码解析接口（`POST /api/v1/order/scan`）
- ✅ 签名验证机制
- ✅ 订单创建和领取流程

### 2. 设备通信接口（按协议重新实现）

#### 2.1 API接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/device/report` | POST | 设备常规状态上报 |
| `/api/v1/device/heartbeat` | POST | 设备心跳上报 |
| `/api/v1/device/command/time_sync` | POST | 后台下发时间同步 |
| `/api/v1/device/command/query_status` | POST | 后台主动查询设备状态 |

#### 2.2 核心组件

1. **Schema定义** (`app/schemas/device.py`)
   - `DeviceStatusReportRequest` - 设备常规状态上报
   - `HeartbeatReportRequest` - 设备心跳上报
   - `ServerAckResponse` - 后台应答
   - `TimeSyncResponse` - 时间同步
   - `QueryDeviceStatusRequest` - 主动查询

2. **设备服务层** (`app/services/device_service.py`)
   - `DeviceService` - 设备服务类
   - `verify_check_code()` - MD5校验码验证
   - `verify_timestamp()` - 时间戳验证
   - `handle_device_status_report()` - 处理状态上报
   - `handle_heartbeat_report()` - 处理心跳上报
   - `create_server_ack()` - 创建应答报文
   - `create_time_sync()` - 创建时间同步报文

3. **API接口** (`app/api/v1/device_communication.py`)
   - `device_report()` - 设备状态上报接口
   - `device_heartbeat()` - 心跳上报接口
   - `send_time_sync_command()` - 时间同步指令
   - `send_query_status_command()` - 查询状态指令

## 🔧 使用方式

### 设备状态上报

```bash
curl -X POST http://localhost:8000/api/v1/device/report \
  -H "Content-Type: application/json" \
  -d '{
    "msg_type": "device_status_report",
    "device_id": "DEV001",
    "timestamp": "2026-01-30 10:00:00",
    "check_code": "计算得到的MD5值",
    "data": {
      "battery_level": 85,
      "location": {
        "longitude": 113.9423,
        "latitude": 22.5431,
        "address": "广东省深圳市宝安区XX街道XX路"
      },
      "smoke_sensor_status": 0,
      "recycle_bin_full": 0,
      "delivery_window_open": 0,
      "is_using": 0,
      "camera_data": {
        "camera_1": [],
        "camera_2": []
      }
    }
  }'
```

### 设备心跳上报

```bash
curl -X POST http://localhost:8000/api/v1/device/heartbeat \
  -H "Content-Type: application/json" \
  -d '{
    "msg_type": "heartbeat_report",
    "device_id": "DEV001",
    "timestamp": "2026-01-30 10:00:00",
    "check_code": "计算得到的MD5值"
  }'
```

## 📝 报文格式

### 完整报文（含包头包尾）

```
0x6868{JSON数据体}0x1616
```

### MD5校验码计算

```python
import hashlib, json

PACKET_HEADER = "0x6868"

def calculate_check_code(packet_data: dict) -> str:
    """
    1. 从JSON数据中去除check_code字段
    2. 按key排序后序列化为紧凑JSON
    3. 拼接包头 + JSON字符串
    4. 计算MD5
    """
    data_copy = {k: v for k, v in packet_data.items() if k != "check_code"}
    json_str = json.dumps(data_copy, ensure_ascii=False, separators=(',', ':'))
    check_str = PACKET_HEADER + json_str
    return hashlib.md5(check_str.encode('utf-8')).hexdigest()
```

### 状态上报响应（server_ack）

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "msg_type": "server_ack",
    "device_id": "DEV001",
    "timestamp": "2026-01-30 10:00:01",
    "ack_code": 0,
    "ack_desc": "接收成功"
  }
}
```

### 心跳响应（time_sync）

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "msg_type": "time_sync",
    "device_id": "DEV001",
    "timestamp": "2026-01-30 10:00:01",
    "time_sync": {
      "standard_time": "2026-01-30 10:00:01"
    },
    "ack": {
      "ack_code": 0,
      "ack_desc": "心跳接收成功"
    }
  }
}
```

## 🔐 安全机制

### 1. MD5校验码验证

- 所有报文必须包含 `check_code` 字段
- 校验范围：包头(0x6868) + JSON数据体（不含check_code）
- 校验失败：丢弃报文，不处理

### 2. 时间戳验证

- 设备时间戳必须在服务器时间 ±5分钟 内
- 超出范围的报文丢弃
- 通过 time_sync 指令校正设备时钟

### 3. 设备注册验证

- 设备ID必须在数据库中已注册
- 未注册设备的报文直接丢弃

## 📊 数据流程

### 状态上报流程

```
4G设备                     后台服务
   |                          |
   |--- 状态上报报文 -------->|
   |                          |-- 验证MD5校验码
   |                          |-- 验证时间戳
   |                          |-- 查询设备
   |                          |-- 更新设备状态
   |<-- server_ack应答 ------|
   |                          |
```

### 心跳上报流程

```
4G设备                     后台服务
   |                          |
   |--- 心跳报文 ----------->|
   |                          |-- 验证MD5校验码
   |                          |-- 验证时间戳
   |                          |-- 查询设备
   |                          |-- 更新在线状态
   |<-- time_sync + ack -----|
   |                          |
```

### 小程序扫码流程

```
4G设备              用户手机              后台服务
   |                   |                    |
   |-- 生成二维码 ----->|                    |
   |                   |-- 微信扫一扫 ------>|
   |                   |                    |-- 验证MD5校验码
   |                   |                    |-- 验证时间戳
   |                   |                    |-- 创建订单
   |                   |<-- 订单详情 --------|
   |                   |                    |
   |                   |-- 确认领取 -------->|
   |                   |<-- 领取成功 --------|
```

## 🧪 测试

### 1. 使用测试脚本

```bash
cd backend
python scripts/test_heartbeat.py
```

### 2. 手动测试

```bash
# 查看API文档（需DEBUG=true）
http://localhost:8000/docs

# 在文档中找到 "设备通信" 标签下的接口进行测试
```

## ⚠️ 注意事项

1. **心跳频率**：协议规定每8小时上报一次心跳
2. **状态上报**：设备状态变化时主动上报
3. **时间同步**：后台收到心跳后自动下发时间同步指令
4. **校验失败**：MD5校验或时间戳验证失败的报文直接丢弃，不返回应答
5. **摄像头数据**：Base64编码的图片数据，每个摄像头最多3张
6. **设备ID格式**：`DEV_YYYYMMDDXXXX`，如 `DEV_202601300001`

## 📚 相关文档

- [设备通信协议设计文档](./设备通信协议设计文档.md)
- [数据库表结构说明](./数据库表结构说明.md)
- [API接口文档](http://localhost:8000/docs)（启动服务后访问）

---

**实现完成时间**：2026-02-08  
**版本**：v2.0  
**参考文档**：《旧物回收通信协议.docx》
