# 小程序功能测试指南

本指南帮助您系统性地测试小程序的各项功能，确保所有功能正常运行。

---

## 📋 测试前准备

### 1. 环境检查

| 检查项 | 操作 | 预期结果 |
|-------|------|---------|
| 后端服务 | 访问 `http://服务器IP:8000/health` | 返回 `{"status":"healthy"}` |
| 数据库 | SSH 服务器执行 `docker ps` | mysql 容器状态为 `Up` |
| Redis | SSH 服务器执行 `docker ps` | redis 容器状态为 `Up` |
| 小程序编译 | 微信开发者工具点击"编译" | 无错误提示 |

### 2. 开发者工具设置

确保在微信开发者工具中：
- ✅ 勾选 **"不校验合法域名、web-view..."**（本地设置）
- ✅ 清除缓存（编译 → 清缓存 → 全部清除）

### 3. 准备测试数据

在服务器上生成测试二维码：

```bash
# SSH 登录服务器
ssh root@你的服务器IP

# 进入项目目录
cd /opt/Clothing_Recycle/backend

# 查询设备密钥
docker exec -it clothing-recycle-mysql mysql -u recycle -precycle123456 --default-character-set=utf8mb4 clothing_recycle -e "SELECT device_id, device_secret FROM devices WHERE device_id='DEV001';"

# 生成测试二维码
docker exec -it clothing-recycle-api python scripts/generate_test_qrcode.py
# 输入设备密钥
# 输入重量（如 3500 克）
```

将生成的 Base64 字符串复制，使用 https://cli.im/text 生成二维码图片。

---

## 🧪 功能测试清单

### 一、用户登录模块

#### 测试1.1：首次登录（新用户）

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 清除小程序缓存和本地存储 | 缓存清除成功 |
| 2 | 重新编译小程序 | 编译成功 |
| 3 | 进入"我的"页面 | 显示"点击登录"提示 |
| 4 | 点击"点击登录"区域 | 自动获取微信授权并登录 |
| 5 | 观察页面变化 | 显示昵称"回收达人"、用户ID、余额等 |

**检查点：**
- [ ] 控制台无错误信息
- [ ] 网络请求 `/api/v1/user/login/wechat` 返回 200
- [ ] 返回数据包含 `token`、`user_id`、`is_new_user: true`

#### 测试1.2：再次登录（老用户）

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 关闭小程序再重新打开 | 自动恢复登录状态 |
| 2 | 进入"我的"页面 | 直接显示用户信息，无需重新登录 |

**检查点：**
- [ ] Token 从本地存储正确读取
- [ ] 用户信息显示正确

#### 测试1.3：退出登录

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 进入"我的"页面 | 显示用户信息 |
| 2 | 滑动到底部，点击"退出登录" | 弹出确认框 |
| 3 | 点击"确定" | 页面刷新，显示"点击登录" |
| 4 | 查看本地存储 | Token 和 userInfo 已清除 |

---

### 二、扫码领取模块（核心功能）

#### 测试2.1：扫码解析

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 确保已登录 | 用户已登录状态 |
| 2 | 点击底部"扫码"Tab | 进入扫码页面 |
| 3 | 点击"扫码领取"按钮 | 调起相机扫码 |
| 4 | 扫描测试二维码 | 显示"解析中..."加载提示 |
| 5 | 等待解析完成 | 弹出领取确认弹窗 |

**检查点：**
- [ ] 弹窗显示投递重量（如 3.50 kg）
- [ ] 弹窗显示回收单价（如 0.30 元/kg）
- [ ] 弹窗显示可领金额（如 1.05 元）
- [ ] 弹窗显示碳减排量
- [ ] 弹窗显示设备信息

#### 测试2.2：确认领取

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 在领取弹窗中点击"确认领取" | 显示"领取中..."加载提示 |
| 2 | 等待领取完成 | 跳转到"领取成功"页面 |
| 3 | 查看领取成功页面 | 显示领取金额、碳减排量等 |

**检查点：**
- [ ] 网络请求 `/api/v1/order/claim` 返回 200
- [ ] 领取成功页面金额显示正确
- [ ] 环保成就数据显示正确

#### 测试2.3：重复扫描同一二维码

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 再次扫描刚才已领取的二维码 | 显示错误提示 |
| 2 | 观察错误信息 | 提示"该订单已被领取" |

**检查点：**
- [ ] 错误提示友好且准确
- [ ] 不会重复入账

#### 测试2.4：扫描过期二维码

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 使用超过有效期的二维码 | 显示错误提示 |
| 2 | 观察错误信息 | 提示"二维码已过期" |

#### 测试2.5：取消领取

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 扫码后在弹窗中点击"取消" | 弹窗关闭 |
| 2 | 页面状态 | 返回扫码页面，可继续扫码 |

---

### 三、投递记录模块

#### 测试3.1：查看投递记录列表

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击底部"记录"Tab | 进入投递记录页面 |
| 2 | 查看记录列表 | 显示历史投递记录 |
| 3 | 检查记录内容 | 每条记录显示日期、重量、金额、状态 |

**检查点：**
- [ ] 刚才领取的订单出现在列表中
- [ ] 金额显示正确
- [ ] 状态显示"已领取"

#### 测试3.2：状态筛选

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击"全部"Tab | 显示所有状态的记录 |
| 2 | 点击"待领取"Tab | 只显示待领取的记录 |
| 3 | 点击"已领取"Tab | 只显示已领取的记录 |
| 4 | 点击"已过期"Tab | 只显示已过期的记录 |

**检查点：**
- [ ] 筛选功能正常
- [ ] "全部"Tab 无报错（之前修复的 status=null 问题）

#### 测试3.3：下拉刷新

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 在记录页面下拉 | 显示刷新动画 |
| 2 | 等待刷新完成 | 列表数据更新 |

#### 测试3.4：上拉加载更多

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 当记录超过一页时 | 滑动到底部 |
| 2 | 观察加载行为 | 自动加载更多数据 |

---

### 四、个人中心模块

#### 测试4.1：查看个人信息

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击底部"我的"Tab | 进入个人中心 |
| 2 | 查看用户信息区域 | 显示头像、昵称、用户ID |
| 3 | 查看资产信息 | 显示钱包余额、积分 |
| 4 | 查看环保数据 | 显示投递次数、重量、减碳量 |

**检查点：**
- [ ] 余额与领取金额一致
- [ ] 投递次数正确累加
- [ ] 投递重量正确累加

#### 测试4.2：编辑个人信息

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击用户信息区域（头像/昵称） | 跳转到编辑页面 |
| 2 | 点击头像区域 | 弹出微信头像选择 |
| 3 | 选择一个头像 | 头像预览更新 |
| 4 | 修改昵称输入框 | 可正常输入 |
| 5 | 输入新昵称（如"测试用户"） | 昵称更新 |
| 6 | 点击"保存修改" | 显示"保存中..." |
| 7 | 等待保存完成 | 提示"保存成功"并返回 |
| 8 | 查看个人中心 | 昵称已更新 |

**检查点：**
- [ ] 网络请求 `PUT /api/v1/user/profile` 返回 200
- [ ] 昵称长度限制生效（最多20字符）
- [ ] 返回后数据刷新正确

#### 测试4.3：昵称验证

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 清空昵称输入框 | 输入框为空 |
| 2 | 点击"保存修改" | 提示"请输入昵称" |
| 3 | 输入超过20个字符 | 提示"昵称不能超过20个字符" |

---

### 五、钱包模块

#### 测试5.1：查看钱包余额

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 在"我的"页面点击"我的钱包" | 进入钱包页面 |
| 2 | 查看余额显示 | 显示当前余额 |
| 3 | 查看交易记录 | 显示收入/支出明细 |

**检查点：**
- [ ] 余额显示正确
- [ ] 交易记录显示刚才的领取收入

#### 测试5.2：提现功能（如已实现）

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击"提现"按钮 | 进入提现页面 |
| 2 | 输入提现金额 | 可正常输入 |
| 3 | 提交提现申请 | 根据实名状态提示 |

---

### 六、首页模块

#### 测试6.1：首页加载

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 启动小程序 | 默认进入首页 |
| 2 | 观察页面内容 | 显示欢迎信息、功能入口 |

#### 测试6.2：快捷入口

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 点击"扫码领取"入口 | 跳转到扫码页面 |
| 2 | 点击"附近回收箱"入口 | 跳转到附近页面 |

---

## 🔧 异常情况测试

### 测试A1：网络断开

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 关闭网络连接 | 网络断开 |
| 2 | 尝试扫码领取 | 提示"网络请求失败" |
| 3 | 恢复网络 | 功能恢复正常 |

### 测试A2：Token 过期

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 等待 Token 过期（7天后）或手动修改 | Token 失效 |
| 2 | 进行需要登录的操作 | 提示重新登录或自动刷新 |

### 测试A3：后端服务不可用

| 步骤 | 操作 | 预期结果 |
|-----|------|---------|
| 1 | 停止后端服务 | 服务不可用 |
| 2 | 尝试各项操作 | 显示友好的错误提示 |

---

## 📊 测试结果记录表

| 功能模块 | 测试项 | 测试结果 | 备注 |
|---------|-------|---------|------|
| 用户登录 | 首次登录 | ⬜ 通过 / ⬜ 失败 | |
| 用户登录 | 再次登录 | ⬜ 通过 / ⬜ 失败 | |
| 用户登录 | 退出登录 | ⬜ 通过 / ⬜ 失败 | |
| 扫码领取 | 扫码解析 | ⬜ 通过 / ⬜ 失败 | |
| 扫码领取 | 确认领取 | ⬜ 通过 / ⬜ 失败 | |
| 扫码领取 | 重复扫描 | ⬜ 通过 / ⬜ 失败 | |
| 扫码领取 | 过期二维码 | ⬜ 通过 / ⬜ 失败 | |
| 投递记录 | 列表显示 | ⬜ 通过 / ⬜ 失败 | |
| 投递记录 | 状态筛选 | ⬜ 通过 / ⬜ 失败 | |
| 投递记录 | 下拉刷新 | ⬜ 通过 / ⬜ 失败 | |
| 个人中心 | 信息显示 | ⬜ 通过 / ⬜ 失败 | |
| 个人中心 | 编辑昵称 | ⬜ 通过 / ⬜ 失败 | |
| 钱包 | 余额显示 | ⬜ 通过 / ⬜ 失败 | |
| 钱包 | 交易记录 | ⬜ 通过 / ⬜ 失败 | |

---

## 🐛 常见问题排查

### 问题1：扫码后无反应

**排查步骤：**
1. 检查控制台是否有错误
2. 检查网络请求是否发出
3. 确认后端服务是否运行
4. 确认二维码格式是否正确

### 问题2：领取失败

**排查步骤：**
1. 检查网络请求响应
2. 查看后端日志：`docker logs clothing-recycle-api`
3. 确认用户是否已登录
4. 确认二维码是否过期

### 问题3：数据不更新

**排查步骤：**
1. 下拉刷新页面
2. 清除小程序缓存
3. 检查后端数据库数据

---

## 📱 调试技巧

### 查看控制台日志

在微信开发者工具中：
- **调试器** → **Console** 查看日志
- **调试器** → **Network** 查看网络请求

### 查看后端日志

```bash
# 实时查看 API 日志
docker logs -f clothing-recycle-api

# 查看最近 100 行
docker logs --tail 100 clothing-recycle-api
```

### 查看数据库数据

```bash
# 查看用户数据
docker exec -it clothing-recycle-mysql mysql -u recycle -precycle123456 --default-character-set=utf8mb4 clothing_recycle -e "SELECT * FROM users;"

# 查看订单数据
docker exec -it clothing-recycle-mysql mysql -u recycle -precycle123456 --default-character-set=utf8mb4 clothing_recycle -e "SELECT * FROM delivery_orders ORDER BY created_at DESC LIMIT 10;"

# 查看钱包流水
docker exec -it clothing-recycle-mysql mysql -u recycle -precycle123456 --default-character-set=utf8mb4 clothing_recycle -e "SELECT * FROM wallet_records ORDER BY created_at DESC LIMIT 10;"
```
