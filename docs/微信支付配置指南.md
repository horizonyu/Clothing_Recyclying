# 微信支付配置指南 - 商家转账到零钱

本指南将帮助您配置微信支付，实现提现到微信零钱功能。

---

## 📋 前置条件

1. **微信支付商户号** - 已申请并通过审核
2. **已开通"商家转账到零钱"功能** - 需要在商户平台单独申请
3. **API证书** - 已下载商户API证书
4. **APIv3密钥** - 已在商户平台设置

---

## 第一步：获取微信支付配置信息

### 1.1 登录微信支付商户平台

访问：https://pay.weixin.qq.com/

使用商户号登录。

### 1.2 获取商户号

在「账户中心」→「商户信息」中查看：
```
商户号 (MCH_ID): 1234567890
```

### 1.3 下载API证书

1. 进入「账户中心」→「API安全」
2. 点击「申请证书」
3. 下载证书压缩包
4. 解压后获得以下文件：
   - `apiclient_cert.pem` - 商户证书
   - `apiclient_key.pem` - 商户私钥（**重要！不要泄露**）
   - `rootca.pem` - 根证书（可选）

### 1.4 获取证书序列号

在「账户中心」→「API安全」→「API证书」中查看证书序列号：
```
证书序列号: 1234567890ABCDEF1234567890ABCDEF12345678
```

### 1.5 设置APIv3密钥

1. 进入「账户中心」→「API安全」→「APIv3密钥」
2. 点击「设置」或「修改」
3. 设置32位密钥（字母数字组合）
4. **记住这个密钥，配置时需要用到**

---

## 第二步：开通"商家转账到零钱"功能

1. 进入「产品中心」
2. 找到「商家转账到零钱」
3. 点击「申请开通」
4. 按提示完成申请
5. 等待审核通过（通常1-3个工作日）

**注意**：此功能需要满足以下条件：
- 商户号注册满90天
- 交易正常，无违规记录
- 部分行业可能无法开通

---

## 第三步：配置后端环境变量

### 3.1 上传证书文件

将下载的证书文件上传到服务器：

```bash
# 在服务器上创建证书目录
mkdir -p /opt/Clothing_Recycle/backend/certs

# 上传私钥文件（从本地）
scp apiclient_key.pem root@服务器IP:/opt/Clothing_Recycle/backend/certs/

# 上传证书文件（可选，当前实现不需要）
# scp apiclient_cert.pem root@服务器IP:/opt/Clothing_Recycle/backend/certs/
```

### 3.2 修改 `.env` 文件

编辑 `/opt/Clothing_Recycle/backend/.env`：

```ini
# 微信支付配置
WECHAT_MCH_ID=1234567890  # 您的商户号
WECHAT_MCH_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678  # 证书序列号
WECHAT_MCH_PRIVATE_KEY_PATH=/opt/Clothing_Recycle/backend/certs/apiclient_key.pem  # 私钥文件路径
WECHAT_MCH_CERT_PATH=/opt/Clothing_Recycle/backend/certs/apiclient_cert.pem  # 证书文件路径（可选）
WECHAT_APIV3_KEY=your-32-char-apiv3-key-here  # APIv3密钥（32位）
```

**重要**：
- `WECHAT_MCH_PRIVATE_KEY_PATH` 必须指向私钥文件的绝对路径
- `WECHAT_APIV3_KEY` 必须是您在商户平台设置的32位密钥
- 证书文件权限应设置为 `600`（仅所有者可读）

```bash
chmod 600 /opt/Clothing_Recycle/backend/certs/apiclient_key.pem
```

---

## 第四步：安装依赖

确保已安装微信支付相关依赖：

```bash
cd /opt/Clothing_Recycle/backend
pip install -r requirements.txt
```

主要依赖：
- `wechatpayv3==1.2.0`（可选，当前实现未使用）
- `cryptography` - 用于签名验证
- `requests` - HTTP请求

---

## 第五步：重启后端服务

```bash
cd /opt/Clothing_Recycle/backend/deploy
docker-compose restart api
# 或
docker-compose up -d --build
```

查看日志确认配置是否正确：

```bash
docker-compose logs -f api
```

看到以下日志表示配置成功：
```
✅ 微信支付客户端初始化成功
```

如果看到错误，请检查：
- 证书文件路径是否正确
- 证书文件是否存在且有读权限
- 商户号、序列号、APIv3密钥是否正确

---

## 第六步：测试提现功能

### 6.1 在小程序中测试

1. 登录小程序
2. 进入「我的钱包」
3. 点击「提现」
4. 输入提现金额（至少1元）
5. 点击「确认提现」
6. 查看微信零钱是否到账

### 6.2 查看后端日志

```bash
docker-compose logs -f api | grep "转账"
```

应该看到：
```
发起微信转账请求: openid=xxx, amount=1.0, withdraw_id=WDxxx
微信转账响应状态码: 200
微信转账响应内容: {...}
```

### 6.3 查询提现记录

可以通过API查询提现状态：

```bash
curl -X GET "http://your-server/api/v1/payment/withdraw/WD202501011234567890" \
  -H "Authorization: Bearer your-token"
```

---

## 常见问题

### Q1: 提示"微信支付服务未配置或不可用"

**原因**：环境变量未配置或证书文件路径错误

**解决**：
1. 检查 `.env` 文件中的所有 `WECHAT_*` 配置项
2. 确认证书文件路径正确且文件存在
3. 确认证书文件有读权限

### Q2: 提示"转账失败: INVALID_REQUEST"

**原因**：请求参数格式错误

**解决**：
1. 检查 `withdraw_id` 格式（不能超过32字符）
2. 检查金额是否小于1元
3. 检查 `openid` 是否正确

### Q3: 提示"转账失败: NO_AUTH"

**原因**：未开通"商家转账到零钱"功能

**解决**：
1. 登录商户平台确认功能已开通
2. 检查商户号状态是否正常
3. 联系微信支付客服

### Q4: 提示"转账失败: OPENID_ERROR"

**原因**：用户OpenID不正确

**解决**：
1. 确认用户在登录时正确获取了OpenID
2. 确认用户的OpenID与小程序AppID匹配

### Q5: 证书文件读取失败

**原因**：文件路径错误或权限不足

**解决**：
```bash
# 检查文件是否存在
ls -l /opt/Clothing_Recycle/backend/certs/apiclient_key.pem

# 修改权限
chmod 600 /opt/Clothing_Recycle/backend/certs/apiclient_key.pem

# 确认文件所有者
chown root:root /opt/Clothing_Recycle/backend/certs/apiclient_key.pem
```

---

## 安全建议

1. **保护私钥文件**
   - 不要将私钥文件提交到Git仓库
   - 私钥文件权限设置为 `600`
   - 定期更换APIv3密钥

2. **生产环境配置**
   - 使用环境变量管理敏感信息
   - 不要在日志中输出完整的证书内容
   - 使用HTTPS传输

3. **监控和告警**
   - 监控提现失败率
   - 设置异常告警
   - 定期检查转账记录

---

## API接口说明

### 提现接口

**POST** `/api/v1/wallet/withdraw`

**请求体**：
```json
{
  "amount": 1.0,
  "channel": "wechat"
}
```

**响应**：
```json
{
  "code": 0,
  "message": "提现申请已提交，资金将即时到账",
  "data": {
    "withdraw_id": "WD202501011234567890",
    "amount": 1.0,
    "channel": "wechat",
    "status": "processing",
    "batch_id": "1030000071100999991182020050600019480001"
  }
}
```

### 查询提现状态

**GET** `/api/v1/payment/withdraw/{withdraw_id}`

**响应**：
```json
{
  "code": 0,
  "data": {
    "withdraw_id": "WD202501011234567890",
    "amount": 1.0,
    "status": "success",
    "channel": "wechat",
    "created_at": "2025-01-01T12:00:00",
    "completed_at": "2025-01-01T12:00:01"
  }
}
```

---

## 费用说明

- **转账手续费**：0.1%-0.6%（根据商户类型）
- **单笔限额**：默认5000元（可申请提高）
- **日限额**：根据商户类型不同

---

## 相关文档

- [微信支付商户平台](https://pay.weixin.qq.com/)
- [商家转账到零钱API文档](https://pay.weixin.qq.com/docs/merchant/apis/batch-transfer-to-balance/initiate-batch-transfer.html)
- [API证书说明](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml)

---

## 技术支持

如遇到问题，请：
1. 查看后端日志：`docker-compose logs -f api`
2. 查看微信支付商户平台通知
3. 联系微信支付客服：95017
